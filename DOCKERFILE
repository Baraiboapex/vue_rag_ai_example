# =================================================================
# STAGE 1: Node.js Builder (To get the clean node_modules)
# =================================================================
FROM node:lts-bookworm-slim AS node_build

WORKDIR /app

# Copy and install Node dependencies
COPY package.json package-lock.json ./
RUN npm install --production

# =================================================================
# STAGE 2: Python/Conda Builder (To create the Python environment)
# =================================================================
FROM nvidia/cuda:12.1.0-runtime-ubuntu22.04 AS python_build

# FIX: Set environment variable to auto-accept Anaconda TOS for non-interactive builds
ENV CONDA_PLUGINS_AUTO_ACCEPT_TOS=true
# Set the default CUDA device environment variable
ENV NVIDIA_VISIBLE_DEVICES=all

# Install Miniconda/Conda on top of the CUDA base image
ENV PATH="/opt/conda/bin:${PATH}"
ARG CONDA_INSTALLER=Miniconda3-latest-Linux-x86_64.sh
RUN apt-get update && apt-get install -y wget bzip2 ca-certificates && \
    wget --quiet https://repo.anaconda.com/miniconda/${CONDA_INSTALLER} -O /tmp/miniconda.sh && \
    /bin/bash /tmp/miniconda.sh -b -p /opt/conda && \
    rm /tmp/miniconda.sh && \
    # Clean Conda cache
    /opt/conda/bin/conda clean --all --yes

# Create and install packages into the Conda Environment
WORKDIR /app
# Combine the environment creation and installation steps for faster build and smaller layers
RUN /bin/bash -c "source /opt/conda/etc/profile.d/conda.sh && \
    # 1. Create the Conda Environment
    conda create -n rag_env python=3.12 -y && \
    conda activate rag_env && \
    \
    # 2. Install FAISS-GPU using CONDA for the best dependency handling
    conda install -n rag_env faiss-gpu -c conda-forge -y && \
    \
    # 3. Install PyTorch with explicit cu121 index
    /opt/conda/envs/rag_env/bin/pip install \
        torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu121 && \
    \
    # 4. Install other Pip dependencies
    /opt/conda/envs/rag_env/bin/pip install \
        transformers \
        accelerate \
        langchain langchain_community \
        pypdf \
        peft \
        bitsandbytes>=0.43.0 --prefer-binary \
        sentence-transformers \
        unidecode" # faiss-gpu removed from pip list

# =================================================================
# STAGE 3: Final Runtime Image (Conda base + Node.js)
# =================================================================
# Use the Python environment stage as the final base
FROM python_build

# Copy the Node.js runtime files from the Node build stage
WORKDIR /app
COPY --from=node_build /app/node_modules ./node_modules

# Copy all the application files (Python scripts and Node API)
COPY . .

# Copy the required Node binary and libraries from the original base image
# This is critical for Node to run on the CUDA/Conda base
COPY --from=node:lts-bookworm-slim /usr/local/bin/node /usr/local/bin/node
COPY --from=node:lts-bookworm-slim /usr/local/lib/node_modules/npm /usr/local/lib/node_modules/npm

# Expose the port (Note: Vertex AI generally expects 8080, but 3000 will work if configured correctly)
EXPOSE 3000

# Set a command to activate the Conda environment, then run the Node app
# The 'bash -c' structure is necessary for environment activation
CMD ["bash", "-c", "source /opt/conda/etc/profile.d/conda.sh && conda activate rag_env && node index.js"]