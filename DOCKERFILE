
FROM ubuntu:22.04 AS python_build

# Stage 1: Build the Python environment
# Use a Node.js base image that has build tools for both languages
FROM node:18-bullseye-slim AS build

# Set the working directory for the Python script
WORKDIR /app/python_scripts

# Install build dependencies
RUN apt-get update && apt-get install -y \
    curl wget build-essential zlib1g-dev libncurses5-dev libgdbm-dev \
    libnss3-dev libssl-dev libreadline-dev libffi-dev libsqlite3-dev \
    libbz2-dev liblzma-dev uuid-dev libdb-dev libexpat1-dev \
    libmpdec-dev libgmp-dev libxext-dev libxrender-dev libx11-dev \
    libgl1-mesa-dev libglx-dev libegl1-mesa-dev libtiff-dev \
    libjpeg-dev libopenjp2-7-dev libwebp-dev libharfbuzz-dev \
    libfribidi-dev libxcb1-dev && \
    wget https://www.python.org/ftp/python/3.12.2/Python-3.12.2.tgz && \
    tar -xf Python-3.12.2.tgz && \
    cd Python-3.12.2 && \
    ./configure --enable-optimizations && \
    make -j$(nproc) && \
    make altinstall

# Set Python 3.12 as default
RUN ln -sf /usr/local/bin/python3.12 /usr/bin/python3 && \
    python3 -m ensurepip && \
    python3 -m pip install --upgrade pip setuptools wheel

RUN /usr/local/bin/python3.12 -m ensurepip && \
    /usr/local/bin/python3.12 -m pip install --upgrade pip setuptools wheel

COPY requirements.txt .
RUN /usr/local/bin/python3.12 -m pip install --no-cache-dir -r requirements.txt

WORKDIR /app/python_scripts
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Stage 2: Build the Node.js application
FROM node:18-bullseye-slim AS final

# Set the working directory for the Node.js app
WORKDIR /app

# Copy the Node.js files
COPY package.json package-lock.json ./
RUN npm install --production

# Copy the Node.js API and the Python scripts from the build stage
COPY . .
COPY --from=build /app/python_scripts /app/python_scripts
RUN find /app/python_scripts -type l ! -exec test -e {} \; -print

# Expose the port your Node.js API listens on
EXPOSE 3000

# Command to run the Node.js API
CMD ["node", "index.js"]